#!/bin/bash
# Omarchy-compatible theme switcher for macOS
# Usage: theme [list|switch <name>|current|install <repo-url>]

OMARCHY_DIR="$HOME/.config/omarchy"
THEMES_DIR="$OMARCHY_DIR/themes"
CURRENT_LINK="$OMARCHY_DIR/current"
# For install, use dotfiles location so themes are git-tracked
DOTFILES_THEMES_DIR="$HOME/dotfiles/themes/.config/omarchy/themes"

case "$1" in
  list)
    echo "Available themes:"
    ls -1 "$THEMES_DIR" 2>/dev/null || echo "No themes directory found"
    ;;

  current)
    if [ -L "$CURRENT_LINK" ]; then
      basename "$(readlink "$CURRENT_LINK")"
    else
      echo "No theme currently set"
    fi
    ;;

  switch)
    THEME="$2"
    if [ -z "$THEME" ]; then
      echo "Usage: theme switch <theme-name>"
      exit 1
    fi
    if [ ! -d "$THEMES_DIR/$THEME" ]; then
      echo "Theme not found: $THEME"
      echo "Available: $(ls -1 "$THEMES_DIR" 2>/dev/null | tr '\n' ' ')"
      exit 1
    fi

    echo "Switching to $THEME..."

    # Update symlink
    rm -f "$CURRENT_LINK"
    ln -s "themes/$THEME" "$CURRENT_LINK"

    # Ensure eza theme symlink exists
    EZA_THEME="$HOME/.config/eza/theme.yml"
    EZA_SRC="$CURRENT_LINK/eza-theme.yml"
    if [ -f "$EZA_SRC" ]; then
      mkdir -p "$(dirname "$EZA_THEME")"
      rm -f "$EZA_THEME"
      ln -s "$EZA_SRC" "$EZA_THEME"
      echo "✓ Eza theme symlink created"
    fi

    # Update Neovim theme symlink
    NVIM_THEME="$HOME/.config/nvim/lua/plugins/theme.lua"
    NVIM_THEME_SRC="$CURRENT_LINK/neovim.lua"
    if [ -f "$NVIM_THEME_SRC" ]; then
      mkdir -p "$(dirname "$NVIM_THEME")"
      rm -f "$NVIM_THEME"
      ln -s "$NVIM_THEME_SRC" "$NVIM_THEME"
      echo "✓ Neovim theme symlink updated"
    else
      rm -f "$NVIM_THEME" 2>/dev/null
      echo "⚠ Theme has no neovim.lua"
    fi

    # Reload Sketchybar
    if command -v sketchybar &> /dev/null; then
      sketchybar --reload 2>/dev/null && echo "✓ Sketchybar reloaded"
    fi

    # Kitty requires restart for theme colors
    if pgrep -x "kitty" > /dev/null; then
      echo "⚠ Restart Kitty for theme colors"
    fi

    # Reload JankyBorders
    if [ -f "$CURRENT_LINK/borders.sh" ] && command -v borders &> /dev/null; then
      source "$CURRENT_LINK/borders.sh"
      borders active_color=$BORDER_ACTIVE inactive_color=$BORDER_INACTIVE width=$BORDER_WIDTH 2>/dev/null
      echo "✓ Borders reloaded"
    fi

    # Update Starship palette
    STARSHIP_CONFIG="$HOME/.config/starship.toml"
    PALETTE_FILE="$CURRENT_LINK/starship-palette.txt"
    if [ -e "$STARSHIP_CONFIG" ] && [ -f "$PALETTE_FILE" ]; then
      PALETTE_NAME=$(cat "$PALETTE_FILE" | tr -d '[:space:]')
      if [ -n "$PALETTE_NAME" ]; then
        # Resolve symlink to get the actual file
        if [ -L "$STARSHIP_CONFIG" ]; then
          REAL_STARSHIP_CONFIG=$(cd "$(dirname "$STARSHIP_CONFIG")" && cd "$(dirname "$(readlink "$STARSHIP_CONFIG")")" && pwd)/$(basename "$(readlink "$STARSHIP_CONFIG")")
        else
          REAL_STARSHIP_CONFIG="$STARSHIP_CONFIG"
        fi
        sed -i '' "s/^palette = .*/palette = '$PALETTE_NAME'/" "$REAL_STARSHIP_CONFIG"
        echo "✓ Starship palette set to $PALETTE_NAME"
      fi
    fi

    # FZF will pick up on next shell
    echo "✓ FZF colors updated (new shells)"

    # Ghostty requires restart
    if pgrep -x "ghostty" > /dev/null; then
      echo "⚠ Restart Ghostty for theme changes"
    fi

    echo ""
    echo "Switched to: $THEME"
    echo "Open a new terminal to see all changes"
    ;;

  install)
    REPO_URL="$2"
    if [ -z "$REPO_URL" ]; then
      echo "Usage: theme install <github-repo-url>"
      exit 1
    fi
    THEME_NAME=$(basename "$REPO_URL" .git | sed 's/omarchy-//' | sed 's/-theme//')
    INSTALL_DIR="$DOTFILES_THEMES_DIR/$THEME_NAME"

    if [ -d "$INSTALL_DIR" ]; then
      echo "Theme already exists: $THEME_NAME"
      echo "Location: $INSTALL_DIR"
      exit 1
    fi

    echo "Installing theme: $THEME_NAME"
    mkdir -p "$DOTFILES_THEMES_DIR"
    git clone "$REPO_URL" "$INSTALL_DIR"

    if [ $? -eq 0 ]; then
      # Remove .git so theme is tracked by dotfiles repo
      rm -rf "$INSTALL_DIR/.git"
      echo "✓ Installed: $THEME_NAME"
      echo ""

      # Check for required files
      MISSING=""
      [ ! -f "$INSTALL_DIR/alacritty.toml" ] && MISSING="$MISSING  - alacritty.toml (colors source)\n"
      [ ! -f "$INSTALL_DIR/kitty.conf" ] && MISSING="$MISSING  - kitty.conf\n"
      [ ! -f "$INSTALL_DIR/ghostty.conf" ] && MISSING="$MISSING  - ghostty.conf\n"
      [ ! -f "$INSTALL_DIR/neovim.lua" ] && MISSING="$MISSING  - neovim.lua\n"
      [ ! -f "$INSTALL_DIR/sketchybar-colors.lua" ] && MISSING="$MISSING  - sketchybar-colors.lua\n"
      [ ! -f "$INSTALL_DIR/borders.sh" ] && MISSING="$MISSING  - borders.sh\n"
      [ ! -f "$INSTALL_DIR/fzf-colors.sh" ] && MISSING="$MISSING  - fzf-colors.sh\n"
      [ ! -f "$INSTALL_DIR/eza-theme.yml" ] && MISSING="$MISSING  - eza-theme.yml\n"
      [ ! -f "$INSTALL_DIR/starship-palette.txt" ] && MISSING="$MISSING  - starship-palette.txt (+ add palette to starship.toml)\n"

      if [ -n "$MISSING" ]; then
        echo "⚠ Missing config files:"
        echo -e "$MISSING"
        echo "Extract colors from alacritty.toml to create missing files."
      else
        echo "✓ All config files present!"
      fi

      echo ""
      echo "Run: cd ~/dotfiles && stow -R themes && theme switch $THEME_NAME"
    else
      echo "Failed to install theme"
      exit 1
    fi
    ;;

  *)
    echo "Omarchy-compatible theme manager for macOS"
    echo ""
    echo "Usage:"
    echo "  theme list              List available themes"
    echo "  theme current           Show current theme"
    echo "  theme switch <name>     Switch to theme (with auto-reload)"
    echo "  theme install <url>     Install theme from GitHub"
    echo ""
    echo "Current: $(theme current 2>/dev/null || echo 'none')"
    ;;
esac
